extends PopupPanel

@onready var feed_content = $VBoxContainer/ScrollContainer/VBoxContainer/HBoxContainer/FeedContent
@onready var close_button = $VBoxContainer/MarginContainer/HBoxContainerFM/Control/CloseButton

func _ready():
	# Basic popup setup
	set_exclusive(true)
	self.position = Vector2(560, 200)
	self.size = Vector2(450, 300)
	
	# Style the panel
	apply_panel_style()
	
	# Connect close button
	if close_button:
		close_button.pressed.connect(_on_close_button_pressed)
	
	# Add sample feed content
	setup_feed_container()

func apply_panel_style():
	var style = StyleBoxFlat.new()
	style.bg_color = Color(0.2, 0.2, 0.2)  # Dark gray
	style.corner_radius_top_left = 24
	style.corner_radius_top_right = 24
	style.corner_radius_bottom_left = 24
	style.corner_radius_bottom_right = 24
	style.border_width_left = 2
	style.border_width_top = 2
	style.border_width_right = 2
	style.border_width_bottom = 2
	style.border_color = Color.hex(0x202020FF)
	self.add_theme_stylebox_override("panel", style)

func setup_feed_container():
	if not feed_content:
		print("Feed content not found!")
		return
		
	# Create a white card for the feed update
	var update_panel = PanelContainer.new()
	var panel_style = StyleBoxFlat.new()
	panel_style.bg_color = Color(1, 1, 1, 1)  # White
	panel_style.corner_radius_top_left = 15
	panel_style.corner_radius_top_right = 15
	panel_style.corner_radius_bottom_left = 15
	panel_style.corner_radius_bottom_right = 15
	panel_style.border_width_left = 2
	panel_style.border_width_top = 2
	panel_style.border_width_right = 2
	panel_style.border_width_bottom = 2
	panel_style.border_color = Color.hex(0x202020FF)
	update_panel.add_theme_stylebox_override("panel", panel_style)
	
	# Add sample feed update content
	var content = RichTextLabel.new()
	content.text = "[b]Feed Update![/b]\n@CdParker And did you see what her date was wearing? Barf. Literally. On myself... it was gross.\n\n[right][color=#FF4040]-375,000 fans[/color][/right]"
	content.autowrap_mode = TextServer.AUTOWRAP_WORD_SMART
	content.add_theme_constant_override("line_spacing", 5)
	content.bbcode_enabled = true
	
	update_panel.add_child(content)
	feed_content.add_child(update_panel)

func _on_close_button_pressed():
	self.hide()

# Add this function to handle new updates
func add_new_update(message: String, follower_change: int):
	if not feed_content:
		print("Feed content not found!")
		return
		
	# Create a white card for the feed update
	var update_panel = PanelContainer.new()
	var panel_style = StyleBoxFlat.new()
	panel_style.bg_color = Color(1, 1, 1, 1)  # White
	panel_style.corner_radius_top_left = 15
	panel_style.corner_radius_top_right = 15
	panel_style.corner_radius_bottom_left = 15
	panel_style.corner_radius_bottom_right = 15
	panel_style.border_width_left = 2
	panel_style.border_width_top = 2
	panel_style.border_width_right = 2
	panel_style.border_width_bottom = 2
	panel_style.border_color = Color.hex(0x202020FF)
	update_panel.add_theme_stylebox_override("panel", panel_style)
	
	# Add new feed update content
	var content = RichTextLabel.new()
	content.text = "[b]Feed Update![/b]\n" + message + "\n\n[right][color=#FF4040]" + str(follower_change) + " fans[/color][/right]"
	content.autowrap_mode = TextServer.AUTOWRAP_WORD_SMART
	content.add_theme_constant_override("line_spacing", 5)
	content.bbcode_enabled = true
	
	update_panel.add_child(content)
	feed_content.add_child(update_panel)
